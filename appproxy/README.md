App-Remote App-Proxy
====================

The App-Remote App-Proxy acts as a wrapper application for an arbitrary process. It is primarily designed for
integration with RabbitMQ and Docker.

The functionality is seperated into distinct and independent modules.

## Proxy Module

At the core of every App-Proxy instance there's the _proxy module_. This module is always active.

Its role is to manage the execution of the configured process.It also provides the output streams of the running process
to the other modules. It also provides the other modules with access to the input stream of the running process, so that
these can feed it with input.

### Application execution

On application startup the configured command is executed.

### File-Based Input

To facilitate passing data to the running application, a file path can be configured.As soon as a file is present at the
configured path, the contents are written to the input stream of the running application.

If no input file is configured, this feature is disabled.

### Application Shutdown

A shutdown handler is configured that supports graceful application shutdown when the app-proxy receives a shutdown
signal. (e.g. `SIGTERM`) This shutdown handler is always active, but by default does not interfere with the normal
shutdown of the application.

A shutdown grace period can be provided:

* If the grace period is negative (or none is configured), the app-proxy waits for the application to terminate on its
  own, without a time limit.
* If the grace period is zero, the app-proxy immediately kills the application.
* If the grace period is positive, the app-proxy waits up to the configured number of seconds for the application to
  terminate on its own. If the application has not terminated once the grace period has expired, it is killed.

### Configuration

* `proxy.command` - the command to be executed for the app to run
* `proxy.input-file` - default: `null` the file path for file based application input
* `proxy.shutdown-grace-period` - default: `-1`. the grace period for application shutdown in seconds

## RabbitMQ Module

The _RabbitMQ module_ connects the app-proxy with a rabbit instance. This module is enabled by default, but can be
disabled. If disabled, the app-proxy simply acts as a wrapper instance for the running application. Most features of
other modules require this module to be active.

Every app-proxy instance that is connected with RabbitMQ is associated with a specific user, and requires a unique
application id.

### RabbitMQ Permissions

For the app-proxy to function properly, it is expected, that a _topic exchange_ named `username.appremote` exists.
The app-proxy required configuration, read, and write permissions for anything matching the username or beginning with
the username. It is recommended to grant the user the following permissions for all 3 categories:

```regexp
^username(\..+)?$
```

The app-proxy always publishes messages onto the _topic exchange_ `username.appremote`. The exchange name is therefore
generally omitted in the following documentation.

The app-proxy generally only consumes _exclusive_ queue. The queue names are generally prefixed
with `username.appremote.appid`. The individual queue names are irrelevant as all queues are generated by the app-proxy
upon startup. The following documentation generally only lists _topic bindings_ that are consumed. The existence of an
exclusive queue and the corresponding bindings is always implied.

### Log Streaming

Both the _stdout_ and _stderr_ output streams of the application are published.
In addition, some log statements of the app-proxy itself are also streamed. These do not include general application
logs, but only targeted logs concerning the interactions between the app-proxy and the application. For example,
whenever the app-proxy sends data to the stdin input stream of the application, this information is also published.

#### Format

Log statements are sent line by line. Each line is marked with the application id and the type of log it
originated from:

```json
{
  "app-id": "application-id",
  "type": "out",
  "line": "this is a log line"
}
```

The 3 possible values of `type` are:

* `out` - application `stdout`
* `error` - application `stderr`
* `proxy` - proxy information

#### Publishing

The 3 message types are published to 3 different topics based on the type:

* `out`-messages: `app-id.outstream.out`
* `error`-messages: `app-id.outstream.error`
* `proxy`-messages: `app-id.outstream.proxy`

### Input Streaming

In addition to publishing the output of the application, the app-proxy also consumes messages that are then sent to the
input stream (`stdin`) of the application.

#### Format

```json
{
  "app-id": "application-id",
  "line": "this is an input line"
}
```

The provided `app-id` must match the application id of the app-proxy. The message will be ignored otherwise. This is a
safety feature ensuring that only the targeted app-proxy processes the message even if it was routed incorrectly.

#### Binding

Input messages are consumed from the topic `app-id.in.stdin`.

### Discovery Heartbeat

For an external application (e.g. the app-remote remote-gui) to interact with a given app-proxy, it needs to be detected
first. This is done through a discovery heartbeat.

Each app-proxy instance consumes the topic `broadcast.internal.discovery`
When a message is received, a response is sent to the application that published the message.

#### Format

A discovery heartbeat request contains a single field `reply-to` indicating the routing key the response should be sent
to.

```json
{
  "reply-to": "app1012342.internal.discoveryResponse"
}
```

The response contains the application id of the app-proxy, as well as additional information about the application.

```json
{
  "app-id": "application-id",
  "start-time": "2018-12-10T13:45:00.000Z",
  "uptime": 34235,
  "modules": [
    "rabbitmq",
    "minecraft"
  ]
}
```

The uptime is measured in seconds. The modules list indicates which app-proxy modules are active. The _proxy module_ is
not listed as it is always active.

## RabbitMQ Topic Overview

| Topic                         | Direction | Module   | Description                  |
|:------------------------------|:---------:|:---------|:-----------------------------|
| app-id.outstream.out          |     W     | rabbitmq | Application stdout stream    |
| app-id.outstream.error        |     W     | rabbitmq | Application stderr stream    |
| app-id.outstream.proxy        |     W     | rabbitmq | App-Proxy logs               |
| app-id.in.stdin               |     R     | rabbitmq | Application stdin injection  |
| broadcast.internal.discovery  |     R     | rabbitmq | Discovery Heartbeat Requests |      

